<% @page_title = @filter.summary %>

<% turbo_refreshes_with method: :morph, scroll: :preserve %>
<%= render "filters/broadcasts", filter: @filter %>

<% content_for :header do %>
  <nav class="align-start">
    <%= link_to root_path, class: "btn", data: { controller: "hotkey", action: "keydown.esc@document->hotkey#click" } do %>
      <%= icon_tag "home" %>
      <span class="for-screen-reader">Home</span>
    <% end %>

    <div class="btn btn--placeholder flex-item-justify-start"></div>

    <header class="flex flex-inline flex-column center flex-shrink">
      <h1 class="txt-large margin-none-block-end">
        <% if @filter.buckets.none? %>
          All collections
        <% elsif @filter.buckets.one? %>
          <%= @filter.buckets.first.name %>
        <% else %>
          <%= @filter.buckets.map(&:name).to_sentence %>
        <% end %>
      </h1>
      <%= render "bubbles/filters", filter: @filter %>
    </header>

    <% if bucket = @filter.buckets.first %>
      <%= link_to edit_bucket_path(bucket), class: "btn flex-item-justify-end" do %>
        <%= icon_tag "settings" %>
        <span class="for-screen-reader">Settings for <%= bucket.name %></span>
      <% end %>

      <%= button_to bucket_bubbles_path(bucket), method: :post, class: "btn" do %>
        <%= icon_tag "add" %>
        <span class="for-screen-reader">Create a new bubble</span>
      <% end %>
    <% else %>
      <div class="btn btn--placeholder flex-item-justify-end"></div>
      <div class="btn btn--placeholder"></div>
    <% end %>
  </nav>
<% end %>

<div class="cards--columns">
  <section class="cards position-relative" style="align-items: center; border-inline-end: 1px solid var(--color-subtle);">
    <h2 class="txt-align-center flex-inline center txt-uppercase txt-medium margin-none-block-start margin-block-end">
      Considering
    </h2>
    <% if (unstaged_bubbles = @bubbles.where(stage: nil)).any? %>
      <%= render partial: "bubbles/card_mini", collection: unstaged_bubbles, as: :bubble, cached: true %>
    <% else %>
      <p class="txt-medium translucent">Nothing here</p>
    <% end %>
  </section>
  <section class="cards gap position-relative" style="align-items: center; view-transition-name: cards-container;" data-controller="bubble-size" data-action="turbo:morph@window->bubble-size#resize">
    <h2 class="txt-align-center flex-inline center txt-uppercase txt-medium margin-none-block-start margin-block-end">
      Doing
    </h2>
    <% if (staged_bubbles = @bubbles.where.not(stage: nil)).any? %>
      <%= render partial: "bubbles/card", collection: staged_bubbles, as: :bubble, cached: true %>
    <% else %>
      <p class="txt-medium translucent">Nothing here</p>
    <% end %>
  </section>
</div>

<div class="margin-block">
  <h2 class="txt-align-center flex-inline center txt-uppercase txt-medium margin-none">
    Recently closed
  </h2>
  <section class="cards--grid position-relative">
    <% if (popped_bubbles = Filter.from_params(@filter.as_params.merge(indexed_by: "popped")).tap { |f| f.creator = Current.user }.bubbles).any? %>
      <%= render partial: "bubbles/card", collection: popped_bubbles, as: :bubble, cached: true %>
    <% else %>
      <p class="txt-medium translucent">Nothing here</p>
    <% end %>
  </section>
</div>
